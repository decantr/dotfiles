#!/bin/sh
#
# boomer to zoomer
#
# a very low iq way to make edits to the LARBS
# files from github.com/lukesmithxyz/voidrice
#

# TODO : remove rsync dep
if ! command -v rsync >/dev/null
then
	printf "::  error must have rsync installed"
	exit 1
fi

[ -f .env ] && . ./.env

if [ -d voidrice ] ; then
	cd voidrice || exit 1
	echo "::  Updating voidrice"
	git clean -dxfq
	git fetch -q --progress
	git reset -q --hard origin/master
else
	git clone https://github.com/LukeSmithxyz/voidrice.git 1> /dev/null &&
		echo "::  Cloned repo"
	cd voidrice || exit 1
fi

printf "::  Is this display HiDPi [y/N] "
read -r REPLY
if [ "$REPLY" = "" ] || echo "$REPLY" | grep -qwE "^[Nn]$"; then
	hidpi=false
elif echo "$REPLY" | grep -qvwE "^[Yy]$"; then
	echo ::  Invalid && exit 1;
fi

# copy files in
cp ../bin/* .local/bin/
cp ../Xresources .config
echo "::  Backing up newsboat urls"
cp ~/.config/newsboat/urls ..
cp ../urls .config/newsboat/
[ -f ../wall.png ] && cp ../wall.png .local/share/bg

# remove bloat
rm README.md LICENSE FUNDING.yml

SCALE=1
OUT="DP-1 --mode 2560x1440 --rate 144"
COLOR="red"

# perform hidpi changes
if $hidpi ; then
	SCALE=2
	OUT="eDP-1 --dpi 192"
	COLOR="blue"
	sed -i 's/350x5-0+24/700-0+48/' .config/dunst/dunstrc
fi

# aliases
sed -i "
/yt=/d
/cp=/d
/mv=/d
/rm=/d
/vim=\"nvim\"/ s/^/# /
" .config/shell/aliasrc
#echo "vf() { fzf | xargs -r -I % \$EDITOR % ;}" >> .config/aliasrc
echo "# My aliases
alias \
	ytsquint='mpv --really-quiet -ytdl-format=43/worst' \\
	yt=\"youtube-dl --add-metadata -i -f 'bestvideo[vcodec*=avc1][height=720]+bestaudio/22' -o '%(upload_date)s-%(title)s.%(ext)s'\" \\
	ytwatch='mpv --really-quiet -ytdl-format=18/best[height=480]/22/135' \\
	ytlisten='mpv --really-quiet -ytdl-format=171/250/bestaudio' \\
	wgon='sudo wg-quick up wg0 && notify-send \"Wireguard Activated\"' \\
	wgoff='sudo wg-quick down wg0 && notify-send \"Wireguard Deactivated\"' \\
	song='youtube-dl -i -f bestaudio -x --audio-format=mp3 --audio-quality 0 --embed-thumbnail -o \"~/Downloads/music/%(uploader)s - %(title)s.%(ext)s\"' \\
	ident='echo \$(curl -s ident.me)' \\
	p='sudo pacman' \\
	SS='sudo systemctl' \\
	bat='cat /sys/class/power_supply/BAT0/capacity' \\
	songplay=\"mpv --no-audio-dispaly\" \\
	ccat=\"highlight --out-format=ansi\" \\
	history=\"history 1\" \\
	dc=\"docker-compose\" \\
	dcr=\"docker-compose run --rm\" \\
	p1a=\"php71 artisan\" \\
	p1at=\"php71 artisan tinker\" \\
	p2a=\"php72 artisan\" \\
	p2at=\"php72 artisan tinker\" \\
	p2atx=\"php72 -dxdebug.remote_autostart=1 artisan tinker\" \\
	p3a=\"php73 artisan\" \\
	p3at=\"php73 artisan tinker\" \\
" >> .config/shell/aliasrc

# PERSONAL
# global exports
sed -i "
	/MOZ_USE_XINPUT2/a export _JAVA_AWT_WM_NONREPARENTING=1
	/MOZ_USE_XINPUT2/a export GDK_SCALE=$SCALE
	/ PATH/a export PATH=\"$HOME/.local/node_modules/bin:\$PATH\"
	/ANSIBLE/a export npm_config_prefix=\"~/.local/node_modules/\"
	s/brave/qutebrowser/
	s/nvim/vim/
	s/mpd/pgrep mpd >\/dev\/null || mpd/
" .zprofile

# default display settings
sed -i "
	s/^#xrdb/xrdb/
	s/xcompmgr/picom/
	/picom/ s/^/# /
	/unclutter/a xrandr --output $OUT &
" .xprofile

# fix screenshot location
sed -i "s/pic-/Pictures\/Screenshots\/pic-/" .local/bin/maimpick

# patches
patch -f -sp0 < ../patches/displayselect.patch

# ncmpcpp
sed -i '/^#user_/ {s/^.//;s/classic/alternative/}' .config/ncmpcpp/config

sed -i '{
	s/caps:super/caps:escape_shifted_capslock/
	s/setxkbmap/setxkbmap -layout gb/
}' .local/bin/remaps

# vimrc
echo "so ~/.vimrc" > .config/nvim/init.vim
cp ../.vimrc .

mkdir -p .config/git
sed "s/NAME/$NAME/;s/EMAIL/$EMAIL/;s/KEY/$KEY/" < ../gitconfig > .config/git/config

# include fzf and change ps1
sed -i "
/be last/i source ~\/.local\/src\/fzf.git\/.fzf.zsh\n
s/PS1=.*/PS1=\"%B%{\$fg[$COLOR]%}%c %{\$reset_color%}>%b \"/
" .config/zsh/.zshrc

sed -i "
/<family>Noto Sans Mono<\/family>/i <family>Mononoki<\/family>
s/Joy Pixels/Font Awesome/g
" .config/fontconfig/fonts.conf

sed -i "
s/-then-hibernate//
s/hibernate/suspend/
" .local/bin/sysact

# Mime configs
echo "
x-scheme-handler/msteams=teams.desktop
" >> .config/mimeapps.list
# END OF CONFIG

git add .
git add .vimrc
git commit -qam "!! Install point !!"

# print out unstaged changes
gh="git --work-tree=$HOME --git-dir=.git"
ch=$($gh status -s --untracked-files=no)
if [ "$ch" != "" ]; then
	# prompt to show
	$gh status -s --untracked-files=no
	printf "::  NOTE: + represents YOUR changes which will be overwritten\n"
	printf "::  Do you want view local changes? [y/N] "
	read -r REPLY
	if echo "$REPLY" | grep -qwE "^[Yy]$"; then
		$gh diff
	fi
fi

# prompt to install
printf "::  Do you want to deploy these changes to the home folder? [y/N] "
read -r REPLY
if echo "$REPLY" | grep -qwE "^[Yy]$"; then
	rsync -a --exclude '.git' . ~
fi

# prompt for changes to system
printf "::  Do you want to edit the current system? [y/N] "
read -r REPLY
if [ "$REPLY" = "" ] || echo "$REPLY" | grep -qwE "^[Nn]$"; then
	exit 0;
fi

# copy mouse and touchpad settings
sudo cp -n ../xorg.conf.d/* /etc/X11/xorg.conf.d/

# vconsole changes
[ -f /etc/vconsole.conf ] || sudo touch /etc/vconsole.conf
# add personal keymaps to uk template
#  this map may be gzipped will need to keep an eye out
[ -f /usr/local/share/kbd/keymaps/personal.map ] ||
	printf "keycode   1 = Caps_Lock\nkeycode  58 = Escape\n" | \
	cat /usr/share/kbd/keymaps/i386/qwerty/uk.map - | \
	sudo tee /usr/local/share/kbd/keymaps/personal.map

( grep -q "KEYMAP" /etc/vconsole.conf ) ||
	sudo sh -c 'echo "KEYMAP=/usr/local/share/kbd/keymaps/personal.map" >> /etc/vconsole.conf'
( grep -q "FONT" /etc/vconsole.conf ) ||
	sudo sh -c 'echo "FONT=ter-116n" >> /etc/vconsole.conf'
$hidpi && sudo sed -i 's/ter-116n/ter-132n/' /etc/vconsole.conf


# Update dependencies
if ! [ -d "../src" ]
then
	mkdir ../src
fi

# shellcheck disable=SC2164 # created above
cd ../src

# dwm
if [ -d dwm ] ; then
	cd dwm || exit 1
	echo "::  Updating dwm"
	git clean -dxfq
	git fetch -q --progress
	git reset -q --hard origin/master
else
	git clone https://github.com/LukeSmithxyz/dwm.git 1> /dev/null &&
		echo "::  Cloned repo"
	cd dwm || exit 1
fi

patch -f -sp0 < ../../patches/dwm-configh.patch
$hidpi && sed -i "/font-awesome/s/15/18/g" config.h

make
sudo make install
cd ..

# dmenu
if [ -d dmenu ] ; then
	cd dmenu || exit 1
	echo "::  Updating dmenu"
	git clean -dxfq
	git fetch -q --progress
	git reset -q --hard origin/master
else
	git clone https://github.com/LukeSmithxyz/dmenu.git 1> /dev/null &&
		echo "::  Cloned repo"
	cd dmenu || exit 1
fi

patch -f -sp0 < ../../patches/dmenu-configh.patch
$hidpi && sed -i "/font-awesome/s/15/18/g" config.h

make
sudo make install
